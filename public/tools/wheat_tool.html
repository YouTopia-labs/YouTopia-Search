<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Weather, AQI & Time Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background-color: #4f46e5;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        pre {
            font-family: 'Fira Code', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: rgba(0,0,0,0.3);
            border-radius: 0.5rem;
            max-height: 60vh;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-slate-800 text-white min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl mx-auto">
        <h1 class="text-4xl font-bold text-center mb-2 text-gray-100">Hyperlocal Weather JSON</h1>
        <p class="text-center text-gray-400 mb-6">Get structured JSON data for any location.</p>

        <!-- Search Input -->
        <div class="flex space-x-2 mb-6">
            <input type="text" id="locationInput" placeholder="E.g., Tokyo, New York, London" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white placeholder-gray-500">
            <button id="getWeatherBtn" class="btn-primary text-white font-semibold px-5 py-3 rounded-lg shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                </svg>
            </button>
        </div>

        <!-- Loader -->
        <div id="loader" class="hidden text-center py-8">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
            <p class="mt-4 text-gray-400">Fetching hyperlocal data...</p>
        </div>
        
        <!-- Error Message -->
        <div id="errorMessage" class="hidden card p-4 rounded-lg text-center text-red-400"></div>

        <!-- Results Display -->
        <div id="results" class="hidden space-y-6">
            <div class="card p-4 rounded-xl">
                 <pre id="jsonOutput" class="p-4"></pre>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const locationInput = document.getElementById('locationInput');
        const getWeatherBtn = document.getElementById('getWeatherBtn');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');
        const resultsDiv = document.getElementById('results');
        const jsonOutputEl = document.getElementById('jsonOutput');
        
        // Event Listeners
        getWeatherBtn.addEventListener('click', fetchWeatherData);
        locationInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                fetchWeatherData();
            }
        });

        // Main function to fetch data
        async function fetchWeatherData() {
            const location = locationInput.value.trim();
            if (!location) {
                showError('Please enter a location.');
                return;
            }

            // UI Reset
            resultsDiv.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                // 1. Geocode location to get lat/lon
                const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1`);
                const geoData = await geoResponse.json();

                if (!geoData.results || geoData.results.length === 0) {
                    showError(`Could not find location: "${location}"`);
                    return;
                }

                const { latitude, longitude, name, country, timezone } = geoData.results[0];

                // 2. Fetch all required data in one go.
                const hourlyParams = "temperature_2m,precipitation_probability,precipitation,rain,showers,snowfall,weather_code,cloud_cover,cloud_cover_low,cloud_cover_mid,cloud_cover_high,visibility";
                const currentParams = "temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m";
                const weatherApiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=${currentParams}&hourly=${hourlyParams}&daily=weather_code,temperature_2m_max,temperature_2m_min&current_air_quality=true&timezone=${timezone}&forecast_days=8`;
                
                const weatherResponse = await fetch(weatherApiUrl);
                const weatherData = await weatherResponse.json();

                // 3. Check for weather data; if it fails, fall back to time-only response.
                if (weatherData.error || !weatherData.current || !weatherData.daily || !weatherData.hourly) {
                    const now = new Date();
                    const fallbackJson = {
                        request_info: {
                            location: name,
                            country: country,
                            latitude: latitude,
                            longitude: longitude,
                            timezone: timezone,
                            retrieved_at: now.toISOString(),
                            status: "Weather data unavailable, showing time only."
                        },
                        local_time: {
                            time: now.toLocaleTimeString('en-US', { timeZone: timezone, hour: '2-digit', minute: '2-digit', hour12: true }),
                            date: now.toLocaleDateString('en-US', { timeZone: timezone, weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
                        },
                        current_conditions: null,
                        air_quality_index: null,
                        daily_forecast_7_days: null,
                        hourly_forecast_24_hours: null,
                    };
                    updateUI(fallbackJson);
                    return; // Exit after showing fallback data
                }

                // 4. If successful, structure the full JSON and update the UI
                const finalJson = structureJsonResponse(weatherData, name, country, timezone);
                updateUI(finalJson);

            } catch (error) {
                console.error('Error fetching data:', error);
                showError('An error occurred. Please check your connection and try again.');
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        function structureJsonResponse(data, name, country, timezone) {
            const now = new Date();

            // Structure current data
            const current = {
                time: data.current.time,
                temperature: data.current.temperature_2m,
                apparent_temperature: data.current.apparent_temperature,
                humidity: data.current.relative_humidity_2m,
                wind_speed: data.current.wind_speed_10m,
                weather: getWeatherInfo(data.current.weather_code),
                units: {
                    temperature: data.current_units.temperature_2m,
                    humidity: data.current_units.relative_humidity_2m,
                    wind_speed: data.current_units.wind_speed_10m
                }
            };
            
            // Structure AQI intelligently from the correct object
            let aqi = null;
            if (data.current_air_quality) {
                if (data.current_air_quality.us_aqi !== null && data.current_air_quality.us_aqi !== undefined) {
                    aqi = {
                        standard: "US AQI",
                        index: data.current_air_quality.us_aqi,
                        level: getAqiInfo(data.current_air_quality.us_aqi, 'US').level
                    };
                } else if (data.current_air_quality.european_aqi !== null && data.current_air_quality.european_aqi !== undefined) {
                     aqi = {
                        standard: "European AQI",
                        index: data.current_air_quality.european_aqi,
                        level: getAqiInfo(data.current_air_quality.european_aqi, 'EU').level
                    };
                }
            }


            // Structure daily forecast
            const dailyForecast = data.daily.time.slice(0, 7).map((time, i) => ({
                date: time,
                weather: getWeatherInfo(data.daily.weather_code[i]),
                temperature_max: data.daily.temperature_2m_max[i],
                temperature_min: data.daily.temperature_2m_min[i],
                units: {
                    temperature: data.daily_units.temperature_2m_max
                }
            }));

            // Structure hourly forecast for the next 24 hours
            let startIndex = data.hourly.time.findIndex(t => new Date(t) >= now);
            if (startIndex === -1) startIndex = 0; // Fallback

            const hourlyForecast = data.hourly.time.slice(startIndex, startIndex + 24).map((time, i) => {
                const originalIndex = startIndex + i;
                return {
                    time: time,
                    temperature: data.hourly.temperature_2m[originalIndex],
                    weather: getWeatherInfo(data.hourly.weather_code[originalIndex]),
                    precipitation: {
                        probability: data.hourly.precipitation_probability[originalIndex],
                        total: data.hourly.precipitation[originalIndex],
                        rain: data.hourly.rain[originalIndex],
                        showers: data.hourly.showers[originalIndex],
                        snowfall: data.hourly.snowfall[originalIndex],
                        units: {
                            probability: data.hourly_units.precipitation_probability,
                            amount: data.hourly_units.precipitation
                        }
                    },
                    cloud_cover: {
                        total: data.hourly.cloud_cover[originalIndex],
                        low: data.hourly.cloud_cover_low[originalIndex],
                        mid: data.hourly.cloud_cover_mid[originalIndex],
                        high: data.hourly.cloud_cover_high[originalIndex],
                        unit: data.hourly_units.cloud_cover
                    },
                    visibility: {
                        value: data.hourly.visibility[originalIndex],
                        unit: data.hourly_units.visibility
                    }
                };
            });


            // Combine into final object
            return {
                request_info: {
                    location: name,
                    country: country,
                    latitude: data.latitude,
                    longitude: data.longitude,
                    timezone: timezone,
                    retrieved_at: now.toISOString()
                },
                current_conditions: current,
                air_quality_index: aqi,
                daily_forecast_7_days: dailyForecast,
                hourly_forecast_24_hours: hourlyForecast,
            };
        }

        function updateUI(jsonData) {
            jsonOutputEl.textContent = JSON.stringify(jsonData, null, 2);
            resultsDiv.classList.remove('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            loader.classList.add('hidden');
        }

        // Helper functions
        function getWeatherInfo(code) {
            const weatherMap = {
                0: { description: 'Clear sky', icon: '☀️' }, 1: { description: 'Mainly clear', icon: '🌤️' }, 2: { description: 'Partly cloudy', icon: '⛅️' }, 3: { description: 'Overcast', icon: '☁️' }, 45: { description: 'Fog', icon: '🌫️' }, 48: { description: 'Rime fog', icon: '🌫️' }, 51: { description: 'Light drizzle', icon: '💧' }, 53: { description: 'Drizzle', icon: '💧' }, 55: { description: 'Dense drizzle', icon: '💧' }, 56: { description: 'Light freeze drizzle', icon: '🥶' }, 57: { description: 'Dense freeze drizzle', icon: '🥶' }, 61: { description: 'Slight rain', icon: '🌧️' }, 63: { description: 'Rain', icon: '🌧️' }, 65: { description: 'Heavy rain', icon: '🌧️' }, 66: { description: 'Light freeze rain', icon: '🥶' }, 67: { description: 'Heavy freeze rain', icon: '🥶' }, 71: { description: 'Slight snow', icon: '❄️' }, 73: { description: 'Snow', icon: '❄️' }, 75: { description: 'Heavy snow', icon: '❄️' }, 77: { description: 'Snow grains', icon: '❄️' }, 80: { description: 'Slight showers', icon: '🌦️' }, 81: { description: 'Showers', icon: '🌦️' }, 82: { description: 'Violent showers', icon: '🌦️' }, 85: { description: 'Slight snow showers', icon: '🌨️' }, 86: { description: 'Heavy snow showers', icon: '🌨️' }, 95: { description: 'Thunderstorm', icon: '⛈️' }, 96: { description: 'Slight hail', icon: '⛈️' }, 99: { description: 'Heavy hail', icon: '⛈️' },
            };
            return weatherMap[code] || { description: 'Unknown', icon: '🤷' };
        }

        function getAqiInfo(aqi, standard = 'EU') {
            if (standard === 'US') {
                if (aqi <= 50) return { level: 'Good' };
                if (aqi <= 100) return { level: 'Moderate' };
                if (aqi <= 150) return { level: 'Unhealthy for Sensitive Groups' };
                if (aqi <= 200) return { level: 'Unhealthy' };
                if (aqi <= 300) return { level: 'Very Unhealthy' };
                return { level: 'Hazardous' };
            }
            // Default to European Standard
            if (aqi <= 20) return { level: 'Good' };
            if (aqi <= 40) return { level: 'Fair' };
            if (aqi <= 60) return { level: 'Moderate' };
            if (aqi <= 80) return { level: 'Poor' };
            if (aqi <= 100) return { level: 'Very Poor' };
            return { level: 'Extremely Poor' };
        }

    </script>
</body>
</html>